import h5py
import numpy as np
import matplotlib.pyplot as plt

# Replace with the actual HDF5 file name generated by the C code
filename = "pixel_data_20250224_044759.h5"

# Open the HDF5 file
with h5py.File(filename, 'r') as f:
    # Check if the 'pixel_hits' dataset exists
    if 'pixel_hits' in f:
        # Read the pixel hits dataset
        pixel_hits = f['pixel_hits'][:]
        print(f"Number of pixel hits: {len(pixel_hits)}")
        
        # Extract x, y coordinates, hit counts, toa, and tot
        x = pixel_hits['x']
        y = pixel_hits['y']
        hit_count = pixel_hits['hit_count']
        toa = pixel_hits['toa']
        tot = pixel_hits['tot']
        
        # Create a 2D histogram of the hits
        hist, xedges, yedges = np.histogram2d(x, y, bins=(256, 256), weights=hit_count)
        
        # Plot 1: Hit Count Heatmap
        plt.figure(figsize=(10, 8))
        plt.imshow(hist.T, origin='lower', extent=[xedges[0], xedges[-1], yedges[0], yedges[-1]], cmap='viridis')
        plt.colorbar(label='Hit Count')
        plt.title('Pixel Hits (Hit Count)')
        plt.xlabel('X Coordinate')
        plt.ylabel('Y Coordinate')
        plt.savefig(f'hit_count_heatmap_{filename.replace(".h5", "")}.png')
        plt.show()
        
        # Plot 2: Time of Arrival (ToA) Heatmap
        plt.figure(figsize=(10, 8))
        toa_hist, _, _ = np.histogram2d(x, y, bins=(256, 256), weights=toa)
        plt.imshow(toa_hist.T, origin='lower', extent=[xedges[0], xedges[-1], yedges[0], yedges[-1]], cmap='plasma')
        plt.colorbar(label='ToA (Time of Arrival)')
        plt.title('Pixel Hits (ToA)')
        plt.xlabel('X Coordinate')
        plt.ylabel('Y Coordinate')
        plt.savefig(f'tot_heatmap_{filename.replace(".h5", "")}.png')
        plt.show()
        
        # Plot 3: Time over Threshold (ToT) Heatmap
        plt.figure(figsize=(10, 8))
        tot_hist, _, _ = np.histogram2d(x, y, bins=(256, 256), weights=tot)
        plt.imshow(tot_hist.T, origin='lower', extent=[xedges[0], xedges[-1], yedges[0], yedges[-1]], cmap='inferno')
        plt.colorbar(label='ToT (Time over Threshold)')
        plt.title('Pixel Hits (ToT)')
        plt.xlabel('X Coordinate')
        plt.ylabel('Y Coordinate')
        plt.savefig(f'toa_heatmap_{filename.replace(".h5", "")}.png')
        plt.show()
    else:
        print("Error: 'pixel_hits' dataset not found in the HDF5 file.")